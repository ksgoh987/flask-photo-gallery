{% extends 'base.html' %}
{% block content %}
<div class="gallery-container">
  <a href="{{ url_for('logout') }}" class="logout-button">🚪 Logout</a>
  <h1>📸 My Photo Gallery</h1>

  <div class="slideshow-with-controls">
    <div class="slideshow" id="slideshow">
      {% for photo in photos %}
      <img src="{{ url_for('static', filename='uploads/' ~ photo) }}" class="{% if loop.first %}active{% endif %}" alt="Photo">
      {% endfor %}
      <div class="nav-buttons">
        <button onclick="prevSlide()">⬅️</button>
        <button onclick="nextSlide()">➡️</button>
      </div>
    </div>

    <div class="controls">
      <button onclick="togglePlayPause()" id="playPauseBtn">⏸️ Pause</button>
      <label for="speed">Speed:</label>
      <select id="speed" onchange="changeSpeed()">
        <option value="2000">2s</option>
        <option value="5000" selected>5s</option>
        <option value="10000">10s</option>
      </select>
      <label>
        <input type="checkbox" id="loop" checked>
        🔁 Loop
      </label>
    </div>
  </div>

  <div id="countdown" class="countdown-timer">⏳ Auto-logout in <span id="timer">60</span>s</div>
</div>

<style>
  /* [unchanged styles] */
</style>

<script>
const images = document.querySelectorAll('.slideshow img');
let current = 0;
let interval = null;
let speed = 5000;
let isPlaying = true;

function showSlide(index) {
  images.forEach((img) => img.classList.remove('active'));
  images[index].classList.add('active');
}

function nextSlide() {
  current = (current + 1) % images.length;
  showSlide(current);
}

function prevSlide() {
  current = (current - 1 + images.length) % images.length;
  showSlide(current);
}

function startSlideshow() {
  if (interval) clearInterval(interval);
  interval = setInterval(() => {
    if (!document.getElementById('loop').checked && current === images.length - 1) {
      togglePlayPause();
      return;
    }
    nextSlide();
  }, speed);
}

function togglePlayPause() {
  const btn = document.getElementById('playPauseBtn');
  if (isPlaying) {
    clearInterval(interval);
    btn.textContent = '▶️ Play';
  } else {
    startSlideshow();
    btn.textContent = '⏸️ Pause';
  }
  isPlaying = !isPlaying;
}

function changeSpeed() {
  speed = parseInt(document.getElementById('speed').value);
  if (isPlaying) startSlideshow();
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') prevSlide();
  if (e.key === 'ArrowRight') nextSlide();
});

const slideshow = document.getElementById('slideshow');
let startX = 0;
let endX = 0;

slideshow.addEventListener('touchstart', function (e) {
  startX = e.touches[0].clientX;
}, false);

slideshow.addEventListener('touchend', function (e) {
  endX = e.changedTouches[0].clientX;
  const deltaX = endX - startX;

  if (Math.abs(deltaX) > 50) {
    if (deltaX > 0) {
      prevSlide();
    } else {
      nextSlide();
    }
  }
}, false);

// Auto logout with countdown
let countdown = 60;
const timerDisplay = document.getElementById('timer');
timerDisplay.textContent = countdown;

let logoutTimer = setInterval(() => {
  countdown--;
  timerDisplay.textContent = countdown;
  if (countdown <= 0) {
    clearInterval(logoutTimer);
    window.location.href = "/logout";
  }
}, 1000);

function resetLogoutTimer() {
  clearInterval(logoutTimer);
  countdown = 60;
  timerDisplay.textContent = countdown;
  logoutTimer = setInterval(() => {
    countdown--;
    timerDisplay.textContent = countdown;
    if (countdown <= 0) {
      clearInterval(logoutTimer);
      window.location.href = "/logout";
    }
  }, 1000);
}

["click", "mousemove", "keydown", "touchstart"].forEach(evt => {
  document.addEventListener(evt, resetLogoutTimer, false);
});

window.onload = function () {
  speed = parseInt(document.getElementById('speed').value);
  startSlideshow();
};
</script>
{% endblock %}
