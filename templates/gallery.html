{% extends 'base.html' %}
{% block content %}
<div class="gallery-container">
  <a href="{{ url_for('logout') }}" class="logout-button">üö™ Logout</a>
  <h1>üì∏ Welcome, {{ user }}</h1>

  <div class="slideshow-with-controls">
    <div class="slideshow" id="slideshow">
      {% for photo in photos %}
      <img src="{{ url_for('static', filename='uploads/' ~ user ~ '/' ~ photo) }}" class="{% if loop.first %}active{% endif %}" alt="Photo">
      {% endfor %}
      <div class="nav-buttons">
        <button onclick="prevSlide()">‚¨ÖÔ∏è</button>
        <button onclick="nextSlide()">‚û°Ô∏è</button>
      </div>
    </div>

    <div class="controls">
      <button onclick="togglePlayPause()" id="playPauseBtn">‚è∏Ô∏è Pause</button>
      <label for="speed">Speed:</label>
      <select id="speed" onchange="changeSpeed()">
        <option value="2000">2s</option>
        <option value="5000" selected>5s</option>
        <option value="10000">10s</option>
      </select>
      <label>
        <input type="checkbox" id="loop" checked>
        üîÅ Loop
      </label>
    </div>
  </div>
  <div id="countdown" class="countdown-timer">‚è≥ Auto-logout in <span id="timer">60</span>s</div>
</div>

<style>
.gallery-container {
  max-width: 100%;
  margin: auto;
  text-align: center;
  padding: 10px;
  font-family: Arial, sans-serif;
}

.slideshow {
  position: relative;
  width: 100%;
  max-width: 600px;
  margin: auto;
  overflow: hidden;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.slideshow img {
  width: 100%;
  display: none;
  transition: opacity 1s ease-in-out;
  border-radius: 10px;
}

.slideshow img.active {
  display: block;
}

.nav-buttons {
  position: absolute;
  top: 50%;
  width: 100%;
  display: flex;
  justify-content: space-between;
  transform: translateY(-50%);
}

.nav-buttons button {
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  border: none;
  padding: 10px;
  font-size: 18px;
  border-radius: 50%;
}

.controls {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  font-size: 16px;
}

.logout-button {
  position: fixed;
  top: 10px;
  right: 10px;
  background: #f44336;
  color: white;
  padding: 5px 10px;
  text-decoration: none;
  border-radius: 4px;
  z-index: 10;
  font-size: 14px;
}

.countdown-timer {
  margin-top: 10px;
  font-size: 14px;
  color: #888;
}

@media (max-width: 600px) {
  .controls label, .controls select, .controls button {
    font-size: 14px;
  }
  .nav-buttons button {
    padding: 8px;
    font-size: 16px;
  }
  h1 {
    font-size: 18px;
  }
}
</style>

<script>
const images = document.querySelectorAll('.slideshow img');
let current = 0;
let interval = null;
let speed = parseInt(document.getElementById('speed').value);
let isPlaying = true;

function showSlide(index) {
  images.forEach((img) => img.classList.remove('active'));
  images[index].classList.add('active');
}

function nextSlide() {
  current = (current + 1) % images.length;
  showSlide(current);
}

function prevSlide() {
  current = (current - 1 + images.length) % images.length;
  showSlide(current);
}

function startSlideshow() {
  if (interval) clearInterval(interval);
  interval = setInterval(() => {
    if (!document.getElementById('loop').checked && current === images.length - 1) {
      togglePlayPause();
      return;
    }
    nextSlide();
  }, speed);
}

function togglePlayPause() {
  const btn = document.getElementById('playPauseBtn');
  if (isPlaying) {
    clearInterval(interval);
    btn.textContent = '‚ñ∂Ô∏è Play';
  } else {
    startSlideshow();
    btn.textContent = '‚è∏Ô∏è Pause';
  }
  isPlaying = !isPlaying;
}

function changeSpeed() {
  speed = parseInt(document.getElementById('speed').value);
  if (isPlaying) startSlideshow();
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') prevSlide();
  if (e.key === 'ArrowRight') nextSlide();
});

const slideshow = document.getElementById('slideshow');
let startX = 0;
let endX = 0;

slideshow.addEventListener('touchstart', function (e) {
  startX = e.touches[0].clientX;
}, false);

slideshow.addEventListener('touchend', function (e) {
  endX = e.changedTouches[0].clientX;
  const deltaX = endX - startX;

  if (Math.abs(deltaX) > 50) {
    if (deltaX > 0) {
      prevSlide();
    } else {
      nextSlide();
    }
  }
}, false);

// Countdown and auto logout
let countdown = 60;
const timerDisplay = document.getElementById('timer');
timerDisplay.textContent = countdown;

let logoutTimer = setInterval(() => {
  countdown--;
  if (countdown >= 0) {
    timerDisplay.textContent = countdown;
  }
  if (countdown === 0) {
    clearInterval(logoutTimer);
    window.location.href = '/logout';
  }
}, 1000);

function resetLogoutTimer() {
  clearInterval(logoutTimer);
  countdown = 60;
  timerDisplay.textContent = countdown;
  logoutTimer = setInterval(() => {
    countdown--;
    if (countdown >= 0) {
      timerDisplay.textContent = countdown;
    }
    if (countdown === 0) {
      clearInterval(logoutTimer);
      window.location.href = '/logout';
    }
  }, 1000);
}

["click", "mousemove", "keydown", "touchstart"].forEach(evt => {
  document.addEventListener(evt, resetLogoutTimer, false);
});

startSlideshow();
</script>
{% endblock %}